{% extends "base.html" %}
{% load static %}

{% block title %}Список покупок{% endblock %}

{% block content %}
<main>
    <section class="filter-section" aria-label="Фильтр по городам">
        <form method="get" class="form-inline" style="margin-bottom: 20px;">
            <label for="city">Город:</label>
            <select name="city" id="city">
                <option value="">Все города</option>
                {% for c in unique_cities %}
                    <option value="{{ c }}" {% if c == selected_city %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
            </select>
            <button type="submit">Фильтровать</button>
        </form>
    </section>

    <section class="sales-table-section" aria-label="Таблица продаж">
        {% if sales %}
        <table class="table">
            <caption>Список покупок</caption>
            <thead>
                <tr>
                    <th scope="col">Покупатель</th>
                    <th scope="col">Email</th>
                    <th scope="col">Телефон</th>
                    <th scope="col">Дата продажи</th>
                    <th scope="col">Дата доставки</th>
                    <th scope="col">Город</th>
                    <th scope="col">Товары</th>
                    <th scope="col">Итоговая цена</th>
                </tr>
            </thead>
            <tbody>
                {% for sale in sales %}
                <tr>
                    <td>{{ sale.customer.first_name }} {{ sale.customer.last_name }}</td>
                    <td>{{ sale.customer.email }}</td>
                    <td>{{ sale.customer.phone }}</td>
                    <td>{{ sale.sale_date|date:"Y-m-d" }}</td>
                    <td>{{ sale.delivery_date|date:"Y-m-d" }}</td>
                    <td>{{ sale.city }}</td>
                    <td>
                        <ul>
                            {% for sale_product in sale.saleproduct_set.all %}
                                <li>{{ sale_product.product.name }}
                                    - {{ sale_product.quantity }} {{ sale_product.product.get_unit_display }}
                                    ({{ sale_product.price }})
                                </li>
                            {% endfor %}
                        </ul>
                    </td>
                    <td>{{ sale.total_price }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>Нет продаж для отображения.</p>
        {% endif %}
    </section>

    <section class="sales-by-customer" aria-label="Продажи по клиентам">
        <header>
            <h2>Продажи по клиентам</h2>
        </header>
        <ul>
            {% for name, total in sales_total_by_customer.items %}
                <li>{{ name }}: {{ total }} <abbr title="Белорусский рубль">BYN</abbr></li>
            {% endfor %}
        </ul>
    </section>

    <section class="sales-statistics" aria-label="Статистические показатели продаж">
        <header>
            <h2>Статистические показатели</h2>
        </header>
        <ul>
            <li>Средняя сумма продаж: {{ sales_mean }} <abbr title="Белорусский рубль">BYN</abbr></li>
            <li>Медиана продаж: {{ sales_median }} <abbr title="Белорусский рубль">BYN</abbr></li>
            <li>Мода продаж: {{ sales_mode }}</li>
            <li>Самый популярный тип товара: {{ most_popular_type }}</li>
            <li>Самый прибыльный тип товара: {{ most_profitable_type }}</li>
        </ul>
    </section>

    <section class="sales-graph" aria-label="График продаж">
        <header>
            <h2>График</h2>
        </header>
        <figure>
            <img src="/media/stats/sale_statistics.png" alt="График продаж по времени">
            <figcaption>График ежемесячных продаж</figcaption>
        </figure>
    </section>

    <section class="product-demand" aria-label="Спрос на товары">
        <header>
            <h2>Товар со спросом и без</h2>
        </header>
        <ul>
            <li>Самый востребованный товар: {{ most_demanded_product_name }}</li>
            <li>Товары без продаж:
                {% if unsold_products %}
                <ul>
                    {% for p in unsold_products %}
                        <li>{{ p.name }}</li>
                    {% endfor %}
                </ul>
                {% else %}
                    Все товары были проданы.
                {% endif %}
            </li>
        </ul>
    </section>

    <section class="monthly-sales" aria-label="Ежемесячный объём продаж по категориям">
        <header>
            <h2>Ежемесячный объём продаж по категориям</h2>
        </header>
        <ul>
            {% for item in monthly_sales %}
                <li>
                    {{ item.month|date:"Y-m" }} — {{ item.product__category__name }}:
                    {{ item.total }} продано
                </li>
            {% endfor %}
        </ul>
    </section>
</main>
{% endblock %}
